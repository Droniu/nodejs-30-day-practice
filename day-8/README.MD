# ðŸ¤ž Deep-Dive into Promises, Polyfills & Async Wizardry

## âš™ï¸ Polyfills, Shims & Transpiling â€” Know the Difference

| Term            | ðŸ’¬ What It Does                                                                 | âš¡ Typical Example                                           |
| --------------- | ------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| **Polyfill**    | Adds a _missing_ feature to a runtime.                                          | Implementing `Promise.allSettled` when Node doesnâ€™t have it. |
| **Shim**        | Same idea as polyfill, but can also _modify_ existing behavior to match a spec. | `es-shim` packages like `array-includes/shim.js`.            |
| **Transpiling** | Converts _new syntax_ â†’ _old syntax_ at build time.                             | Babel turns `async/await` â†’ generator + `Promise` code.      |

ðŸ§  **Interview gold:**

- Polyfill = _runtime patch_.
- Transpile = _build-time rewrite_.
- Shim = _patch, possibly override existing behavior_.

## ðŸ§© The Script â€” Custom `Promise.allSettled` Polyfill

```js
if (!Promise.allSettled) {
  Promise.allSettled = function (promises) {
    const results = promises.map((promise) =>
      Promise.resolve(promise)
        .then((value) => ({ status: "fulfilled", value }))
        .catch((reason) => ({ status: "rejected", reason }))
    );
    return Promise.all(results);
  };
}
```

### ðŸ” What It Does

- Checks if `Promise.allSettled` exists; if not, defines it.
- Converts **any input** (value, promise, or thenable) into a real Promise via `Promise.resolve()`.
- Returns an array of results like:

  ```js
  [
    { status: "fulfilled", value: ... },
    { status: "rejected", reason: ... }
  ]
  ```

- Waits for _all_ promises to settle â€” never rejects as a whole.

âœ… **Spec-correct**
âœ… **Handles plain values, thenables, and mixed arrays**
âœ… **Preserves order of input promises**

Run your test suite with:

```bash
npm run test
```

## ðŸ’¡ Key Promise Tips & Interview Triggers

### ðŸ§± Promise Basics

- A Promise represents a value that may resolve in the **future**.
- `.then()` and `.catch()` callbacks run in the **microtask queue** (after sync code).
- `.finally()` runs after either resolve or reject.

### â±ï¸ Microtasks vs Macrotasks

| Type          | Example                           | Runs                                 |
| ------------- | --------------------------------- | ------------------------------------ |
| **Microtask** | `Promise.then`, `queueMicrotask`  | After current stack, before timeouts |
| **Macrotask** | `setTimeout`, I/O, `setImmediate` | After microtasks finish              |

```js
setTimeout(() => console.log("timeout"));
Promise.resolve().then(() => console.log("promise"));
console.log("sync");
// sync â†’ promise â†’ timeout
```

### ðŸ§© Async Function Mechanics

| Form                             | Returns                      | Notes                                |
| -------------------------------- | ---------------------------- | ------------------------------------ |
| `return new Promise()`           | Custom async logic           | Used when you _build_ async manually |
| `return Promise.resolve(x)`      | Immediately resolved Promise | Normalizes sync to async             |
| `return somePromise()`           | Forward result               | âœ… No extra microtask                |
| `return await somePromise()`     | Waits inside, adds microtask | Useful for `try/catch`               |
| `return await Promise.resolve()` | ðŸ¤¡ redundant                 | Double-wrapped nonsense              |

**Golden rule ðŸ§ :**

> Use `await` only when you need to _do something after_ the Promise resolves.
> Otherwise, just return it.

### â³ Microtask Delay in Practice

```js
let done = false;
Promise.resolve().then(() => (done = true));
console.log(done); // false (callback runs later)
```

But:

```js
Promise.resolve((done = true));
console.log(done); // true (assignment runs before promise creation)
```

> Promises are async only in _resolution_, not in _creation_.

### ðŸ”¥ Advanced Promise Tricks

- **Promise.all** â†’ fails fast if any reject.
- **Promise.allSettled** â†’ waits for all, never rejects.
- **Promise.any** â†’ resolves with the _first success_, ignores rejects.
- **Promise.race** â†’ resolves/rejects with the _first settled_ promise.

| Feature      | Rejects early?           | Waits for all? |
| ------------ | ------------------------ | -------------- |
| `all`        | âœ… yes                   | âŒ no          |
| `allSettled` | âŒ no                    | âœ… yes         |
| `race`       | âœ… yes                   | âŒ no          |
| `any`        | âŒ no (until all reject) | âŒ no          |

### ðŸ§  Common Gotchas

- `Promise.resolve()` evaluates its argument _immediately_.
- `await` always yields control back to the event loop (adds a microtask tick).
- Multiple `await`s can reorder logs even in synchronous-looking code.
- `Promise.resolve(promise)` = _idempotent_ (returns same promise, doesnâ€™t wrap twice).

### âš™ï¸ Debugging Tips

- Use `Promise.allSettled()` when debugging async chains â†’ no â€œunhandled rejectionâ€ spam.
- If async test fails randomly â†’ missing `await` or microtask timing.
- To flush microtasks manually:

  ```js
  await Promise.resolve();
  ```

## ðŸ Quick Recap (Interview Checklist)

âœ… Whatâ€™s a polyfill / shim / transpiler?
âœ… Whatâ€™s the event loop order (sync â†’ microtasks â†’ macrotasks)?
âœ… What does `Promise.resolve()` really do?
âœ… When to use `await` vs direct return?
âœ… Difference between `Promise.all`, `.allSettled`, `.race`, `.any`?
âœ… Why is this polyfill correct?

If you can answer all that â€” youâ€™re officially async-certified, bro ðŸ˜Žâš¡

> ðŸ’¬ _â€œPromises donâ€™t make code faster â€” they make it predictable.â€_
> Now go melt interviewersâ€™ brains.
